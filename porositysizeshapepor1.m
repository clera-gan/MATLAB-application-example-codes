function nonfitting
clear all
clc

dp=1.0e-6*[2	5	10	20	50	100	200	1000];
sph=[0.696	0.911	0.984	1	0.973387526	0.929	0.886291095	0.847880295	0.814]';
ap=[0.25 0.5 0.75 1.0 1.5 2.0 2.5 3.0 3.5]';
sph1=ones(9,1)-sph;
por=[0.12425	0.22529	0.26914	0.34324	0.48167	0.54743	0.5797	0.59612
0.18936	0.28812	0.29913	0.42064	0.55422	0.61987	0.64337	0.65564
0.24586	0.32891	0.3452	0.47264	0.57915	0.6321	0.64992	0.65923
0.28961	0.34072	0.37803	0.47932	0.57996	0.6077	0.61387	0.62046
0.27566	0.32479	0.35994	0.44253	0.5651	0.63278	0.65344	0.66654
0.26097	0.30335	0.33033	0.398	0.54204	0.62138	0.64728	0.66116
0.2288	0.29208	0.29771	0.36328	0.52027	0.60214	0.62853	0.64308
0.2125	0.25888	0.27286	0.3411	0.49923	0.58019	0.60687	0.62174
0.17981	0.23317	0.24125	0.31498	0.47015	0.55616	0.58475	0.59951];
whos por
por=ones(9,8)-por;

% prolate
% dp=1.0e-6*[2	5	10	20	50	100	200	1000];
% sph=[1	0.973387526	0.929	0.886291095	0.847880295	0.814]';
% sph1=ones(6,1)-sph;
ap=[1.0 1.5 2.0 2.5 3.0 3.5]';
por=[0.272462	0.340718	0.378025	0.479318	0.579964	0.6077	0.613872	0.620463
0.275656	0.324789	0.359939	0.442529	0.5651	0.632782	0.653444	0.666537
0.260972	0.303354	0.330334	0.398	0.54204	0.621379	0.647283	0.661162
0.228803	0.292079	0.29771	0.363275	0.520272	0.602138	0.628527	0.64308
0.212501	0.258882	0.272861	0.341098	0.499235	0.580186	0.606875	0.621739
0.179815	0.233169	0.241246	0.314983	0.470155	0.556157	0.584749	0.599508];
por=ones(6,8)-por;
% oblate 
% dp=1.0e-6*[2	5	10	20	50	100	200	1000];
% sph=[0.696	0.911	0.984	1]';
% ap=[0.25 0.5 0.75 1.0]';
% por=[0.12425	0.22529	0.26914	0.34324	0.48167	0.54743	0.5797	0.59612
% 0.18936	0.28812	0.29913	0.42064	0.55422	0.61987	0.64337	0.65564
% 0.24586	0.32891	0.3452	0.47264	0.57915	0.6321	0.64992	0.65923
% 0.28961	0.34072	0.37803	0.47932	0.57996	0.6077	0.61387	0.62046];
% por=ones(4,8)-por;
whos dp sph por ap
rhoA=(2500/6.5e-20)^0.129;


%plot(p,T,'*-')
%hold on
% prolate
% k0=[0.3 20 2.5 0.3]; 
% oblate
  k0=[20 0.3 0.31 ]; 
%fun = inline('k(1)*kk^k(2)*exp(k(3)*p)','kk','p');
%[k,r,j] = nlinfit(kk,p,T,fun,k0);
[k,resnorm,residual,exitflag,output,lambda,jacobian] = lsqnonlin(@fun,k0,[],[],[],dp,ap,por);
k
residual;

for i= 1:1:6
if(ap(i)<=1.0)    
ep0(i)=0.366*ap(i)^2-0.453*ap(i)+0.457;
%prolate
else
ep0(i)=0.132*ap(i)^(-2)+0.039*ap(i)+0.199;
end
i=i+1;
end
ep0=ep0';
porfit=(ep0*ones(1,8)+(ones(6,1)-ep0)*ones(1,8).*exp(-k(1)*(ap).^k(2)*dp.^k(3)))
plot(por, porfit, '*')
axis([0.2 0.9 0.2 0.9]);

r=sum(sum(residual.^2));
aver=sum(sum(por))/48;
d=sum(sum((por-aver*ones(6,8)).^2));
R = 1-r/d

function f=fun(k,dp,ap,por)
%k=[k(1) k(2) k(3)]
% oblate
for i= 1:1:6
if(ap(i)<1.0)    
ep0(i)=0.366*ap(i)^2-0.453*ap(i)+0.457;
%prolate
else
ep0(i)=0.132*ap(i)^(-2)+0.039*ap(i)+0.199;
end
i=i+1;
end
ep0=ep0';
f=por-(ep0*ones(1,8)+(ones(6,1)-ep0)*ones(1,8).*exp(-k(1)*(ap).^k(2)*dp.^k(3)));
